const axios = require('axios');
const { getPrinters } = require('../database_getters/printers');
const cheerio = require('cheerio');
const Database = require('../db/db');

const timer = ms => new Promise(res => setTimeout(res, ms))


let SHOPAUTH = '26B9599D49387581C7C710F04ED6D7A85DFAF4EE5C60E2865BFD6B2527C5DDEB499329D807974323ECABCFDBDA04B11C43355EB838441C1EE60D37C9BD125BE84D9BD0BA99B7505D4B0C55A2092C86D45D98151491158B086F6ACA5B5FEC1723A1537C2EF0B78CB4E304E1219A3D10C1E71219130E4707B5133A04AFD24ED920BAA3FDDF50FEC55B456F87A0AA2D71CABF0C4E991EBBEBB4A729A0B9AEA29096708CCE50F70BA81CFE72F41D487E8B48B78147238558FE199DEC41F4E011F74045F90F9D27758A121BE56B7B1FD1CE57AD3AB2E9A3B9935E2316CE6382FF1D8480BB2CFF727EC15077D480C9B4160CC2C31D07EEEC2811A6B08F09E318D433D00F4911B5CD3131CFFAD267EB9E24DD433BE12572BFD660805EDC73D908D54B99D0CF219187C3B4FC4933CB60C306EE4DAD59C6296099623E16484076C21AF485043D267D810BF624E4F63BCDB010891AF2D0EB997A4839F572D2F856779BB97256394FFA3D57978DEEED7BC8C75B78695FB2B810018454C7FF99846985B3F7F121DA2766D4322D431C6898EE8FD93E8A0CF234B865918B9130A85D4A5DFB5585F95952FF449E4AAEA5F05941097CE92BE7E3BF27552F2D8C59C5EEC820D749E39AB723B1A352E0B4EEF0B925B182A38A7E97A3FD02BD055101BD2BF42ECAD95312D5B77D5045AB977F61C2E1E64AB3F30E44C06BF7B3E4C3B599110C911B2323736A101F9D2731CCB13DA087A2E79CA4F778FA86DB1E130665A6AB9C76B1E69026F6F03C8ECFE8A52ABCAE5A7E91A47AE4F36B4EBDB9747F26E7A78F318564D733B4DD4E1700A4555142032755DF14D1B13194492B3F2EF12942B08C8690C3CB8BC65A5B4D4D211F12CF1BF3328FD69FBC7F499341BFF0C4C18AA1BF170E318FD25E118788FB9C05338C399D1FCB1F880037255D9858CC2B49FF64BE8CFFA2416F5D0AF0C2CD10918BCFFF9FCE6EF10FBA15FF0DCAFE5AD9E673FD6636645CE67CDCA39F7F0B72C98A29BEAD75B37499B0C629333E01871CD1367C1F7CAB7EDD15B3D53413EFD979C816F8EB447ABD43D2CD8BD48B1DAAC0A61A5BDEB6F6A1E207220583861B050B12D568C10645C198D05B528D426ED210292CDA13692D53AEC5C300220FB526C863C15C3B06B13DE4EDA396F29E25FCEC2C8B59E9E3EA8BEA4BDB54285BA682E14AEC201FA71D300619BDB7051E2BC84DD4ACDA57520BD6BB52081C6BA7E2B96756CD58129C8DCBBA4C9EBCE8EB2695E46C72D55471F46454565A3C8D418D83AA66C1E48A575F7868A8C1DD5439F1E51CC6BCFC5CD384B2CD60BD7D42AD21AB6C06FE965D8E568BF693952B69039B6459C35BCFF7CB0FA582E64F8B0A17134ADECD77E2DBB8367E95C03F490FEF5C2F54383FC9AA7A2F7855B04D306DBAE6AA0BF538C169E12A3F70CB88534FBE75975D59932F3A4A3876C53F9E78108EA0084A498ADA91C26539BA801F014DA5650FC1D309480731C65D3FFF41B38EA2A3063A7A54697206AC959D6C82F9C9A53C956647653ACEB7D0AEC1F76FD39D212EC596DD41D063C01174FD8BC38C701D47C5E65B0D0FC9E950F722B82A195CC83F55B90F10A9F7252616A0BC9B9D64369C459E7F2B92FC781ACC8B06C73A2C19A30282FD2D875FD1A2EB3D54FC599F6EFE11762308D0BCF1DBA6390035DED83960536B1E357BCD40603970388086EA7BBA0A30E731E3DA8B60398F15F6DDF6BE5F3F1F7B29C5184C7214DC9FAFEC8688BD953F6E6862464EBA8BB8F3C73BEEA02596F17543FE5D879D141C5E74406FD3B0C1FE250C96794065919BFA4DB5BFFC5129C4F9E29143F81427B3F65DF1D8EC25287C294801FDAB5FC07F24671B22285E6E9B02B370893B5C37E82E05224B0A48D7E291B66ECCF6D123B116CA84D3AD6C25BB8F6D5B6D443908B2DB623761D0DA093C8ACB6DE7856E4050CA657B9A77EC2334863FE653F6E556A4A81778C1EC5A391910BD59F9620539CE4212E355460BBAC74545E85A5835458CC829D30EE24D9865B3BF4D9D21FCFB86A577EBF4B8A20D3CCABD3182F8E837DC634B939C63E962C9D171653DF999E11FC133D4C6E676FC38D34E5A0BA90AC282FD266BEA7C25C606310081BC39701BE800F199F7A759AD54FFB4A9D3B83D51AFDC2C64E46CADA32A39B26912B86E0F5544C04C9B8AF8C27AE340F7D090519F40C22E7D7DD4AA003C0778D97865079628DE0472F4703B80116C47FF0E82F3AAF3C48565C7371CE7BDDA224C259C34B6FC0C7D2CD62A0E6AC6773AE397EB4EEB5C0AC9AA00D0584F332EBDFCCCF67A05A21B49040A93D1BEA2EC4FDF1DEDB7E43B17EB98C654B2567D4CCBE8F78F290735C5E6C5035323F3B1449FA968D116D15BDEC72E791880B78709AD68FF41E986762D27BC2BBA2FA03E6681374AEA5F35DB05F92F35CF9B0402747D36C7EE52E85769FEFFDBAABD8A945E6813FAC06E034431F01A1027C0ECF2B0B9C221A53A97060C4C10F1335239030CC90B420C36DAB9A8C4CCBAF3B0BC04B694E8D8418AA7557714F3981976FF6DFE02ECB19A3A30747D3CE7E54438A863EC43F76A5A33F2DBB133B86E15C27123D5B6F61274AB7A5A7A8D3C5EF5D8BE623C899F759D48014C537CAF05002F8952D81F7975115DAAFB3E390A00106EE657D082DED2446B9093822F55E09261CA8B5790751F9B4E1B8FF2DDF1E888EC7212E6FDF14A49AF801D42497933662A0173136C2C360BA9B805BB72C8B0BA3C1773755221A57C8F1E4FC11EC674';
let config = {
  headers: {
	"accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
	"accept-encoding": "gzip, deflate, br",
	"accept-language": "en-US,en;q=0.9,hr;q=0.8,de;q=0.7",
	"cache-control": "max-age=0",
	"cookie": `_ga=GA1.2.680656993.1619101099; _hjid=0b4fa19e-56ad-4c85-8e58-8e56eaec1667; s_fid=78AD385AD37DD7CC-0B4C18C3F0228DA5; cookies-allowed={"General":true,"Marketo":true,"Qualtrics":true,"GoogleAnalytics":true}; __utma=155020967.680656993.1619101099.1619116840.1619721121.2; _mkto_trk=id:946-OMQ-360&token:_mch-techdata.com-1619101106794-30621; rxVisitor=1637154812403VI3I13O6GIJA7C9DVOQRGNQCJOELO823; _gcl_au=1.1.899738080.1637154991; QSI_SI_aXdsQSZ8S3ba3xX_intercept=true; _gid=GA1.2.544254612.1637155334; _hjSessionUser_1861767=eyJpZCI6ImYxNTE4ZWViLTNiMzQtNTU0MC1iN2UwLTk0OTQ5NzZkYWY5ZCIsImNyZWF0ZWQiOjE2MzcxNTU5ODE0NDYsImV4aXN0aW5nIjp0cnVlfQ==; dtCookie=v_4_srv_10_sn_6437CE9D46475E766FA69E5887669AC2_perc_100000_ol_0_mul_1_app-3Aea7c4b59f27d43eb_1; nlbi_913313_2497096=Z7brZBpyYX6i41m3AHvFeQAAAACQdkkmrgfBpOaOr7FquuoE; nlbi_913313=8v/yEnGiqT7bcFaPAHvFeQAAAAAc1jTNe/eFzZkpzRY5KkKK; AMCV_D3FF7C0A5A20164A0A495ECB%40AdobeOrg=-1124106680%7CMCIDTS%7C18949%7CMCMID%7C25509423763880970231725178591258605769%7CMCAAMLH-1637765595%7C6%7CMCAAMB-1637765595%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1637167995s%7CNONE%7CvVersion%7C5.2.0; AMCVS_D3FF7C0A5A20164A0A495ECB%40AdobeOrg=1; s_tp=3789; s_cc=true; incap_ses_197_1065319=3k4ZXAT00G5tiuR3DuO7AmMXlWEAAAAAorRbSRx8hXsisRJ9cXDUug==; BIGipServerSHOP_443=2328598953.47873.0000; s_ips=2890; s_ppv=us%253Aen%253Ahomepage%2C84%2C76%2C3190%2C3%2C4; s_plt=1.41; s_pltp=us%3Aen%3Ahomepage; rxvt=1637162624472|1637160822720; dtPC=10$360822714_538h-vOTQKNCTBPPQGPMKCHTAAUKMHUUHFSSJA-0e0; dtSa=true%7CC%7C-1%7CSIGNING%20ON...%7C-%7C1637160826341%7C360822714_538%7Chttps%3A%2F%2Fsso.techdata.com%2Fas%2Fauthorization.oauth2%3Fclient_5Fid%3Dshop_5Fclient%26response_5Ftype%3Dcode%26redirect_5Furi%3Dhttps%3A%2F%2Fshop.techdata.com%2Foauth%26pfidpadapterid%3DShieldBaseAuthnAdaptor%26scope%3Dfreight_2520warranty%7C%7C%7C%7C; dtLatC=3; LiveGuide_4zIYzwGA79qVamm546-tiIsv9_date=1637162385221; LiveGuide_4zIYzwGA79qVamm546-tiIsv9_url=https%3A%2F%2Fshop.techdata.com%2Fproducts%2F12747959; LiveGuide_4zIYzwGA79qVamm546-tiIsv9_title=Shop%20With%20Tech%20Data%20%7C%20Product%20Details; LiveGuide_4zIYzwGA79qVamm546-tiIsv9_ref=; incap_ses_197_500318=pmQiSGhZj2Z/d/N3DuO7AmwllWEAAAAAHPN6fYQRx1HXFrYicfoI9A==; _hjSession_1861767=eyJpZCI6IjEwODk3ZTA0LWVjNjAtNDY5Mi1hYjQ2LTZjYWFiYTc1ZWM0NCIsImNyZWF0ZWQiOjE2MzcxNjQzOTE4MDJ9; _hjAbsoluteSessionInProgress=0; incap_ses_197_913313=TlQPEF6DHUBUfvN3DuO7Am8llWEAAAAAacCVTt3Ox7gCSc0YXUsZWg==; BannerAdSMB=true; LiveGuide_4zIYzwGA79qVamm546-tiIsv9_duration=3187733; s_sq=techdatatd-staging%3D%2526c.%2526a.%2526activitymap.%2526page%253Dus%25253Aen%25253Ahomepage%2526link%253DPrint%252520Solutions%2526region%253Dlist-03caa3956c%2526pageIDType%253D1%2526.activitymap%2526.a%2526.c%2526pid%253Dus%25253Aen%25253Ahomepage%2526pidt%253D1%2526oid%253Dhttps%25253A%25252F%25252Fwww.techdata.com%25252Fus%25252Fen%25252Fsite%25252Fproducts-list%25252Fprint-solutions.html%2526ot%253DA; QSI_HistorySession=https%3A%2F%2Fshop.techdata.com%2Fproducts%2Fcategory%2Fcategory%3Fcs%3D500001003%26refinements%3D500100301~1637160931922%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2Fcategory%2Fcategory%3Fcs%3D500001003%26refinements%3D510030102%26enav%3D500000000%26searchType%3Dproducts~1637160956707%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2Fcategory%2Fcategory%3Fcs%3D500001003%26refinements%3D500100301~1637160962163%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F13528185%2F%3FP%3D13528185%26isValuePartOnly%3DFalse~1637162373899%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12747959~1637162384707%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12109488~1637164392566%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12612481~1637164416635%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12109488~1637164428643%7Chttps%3A%2F%2Fshop.techdata.com%2FtdPartSmart~1637164831242%7Chttps%3A%2F%2Fshop.techdata.com%2F~1637165054563%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F13528185%2F%3FP%3D13528185%26isValuePartOnly%3DFalse~1637165059457%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12079134~1637165065914%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12612481~1637165088080%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12109488~1637165488755%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12612481~1637165572492%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12079134~1637165577469%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2Fcategory%2Fcategory%3Fcs%3D500001003%26refinements%3D500100301~1637165582041%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F13111615%2F%3FP%3D13111615%26isValuePartOnly%3DFalse~1637165793241%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F12015865~1637165799653%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2F13111615%2F%3FP%3D13111615%26isValuePartOnly%3DFalse~1637166089206%7Chttps%3A%2F%2Fshop.techdata.com%2Fproducts%2Fcategory%2Fcategory%3Fcs%3D500001003%26refinements%3D500100301~1637166092735; _gat=1; .SHOPAUTH=${SHOPAUTH}`,
	"sec-ch-ua": '" Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"',
	"sec-ch-ua-mobile": '?0',
	"sec-fetch-dest": 'document',
	'sec-fetch-mode': 'navigate',
	'sec-fetch-site': 'none',
	'sec-fetch-user': '?1',
	'upgrade-insecure-requests': '1',
	'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36'
  }
}

function genRand(min, max, decimalPlaces) {
    return (Math.random() * (max - min) + min).toFixed(decimalPlaces) * 1;
}

async function findToners(){
	let printers = await getPrinters();

	let baseUrl = 'https://shop.techdata.com/api/products/accessories/';
	

	printers = printers.slice(2)

	for(let i = 0; i < printers.length; i++){
		let Matnr = printers[i].Matnr;

		let { data } = await axios.get(baseUrl + Matnr, config)

		let $ = cheerio.load(data);

		let list = $("ul").find("li")

		if(list.length === 0) continue;

		let allItems = [];

		list.each((index, el) => {
			let title = $(el).find("input").data("productname")

			if(!title.includes("cartridge")) return; 

			let cost = Number($(el).find("input").data("bestprice").substr(1));
			let matnr = $(el).find("input").data("matnr");
			let printerNumber = Matnr;

			cost = Number.isNaN(cost) ? 0 : cost;

			let rating = genRand(4.5,5,1);
			allItems.push({title,cost,matnr, printerNumber, rating})
		})

		let tonersSet = new Set()

		let dict = {}

		allItems.forEach( item => {
			if(!dict[item.title]) tonersSet.add(item)

			dict[item.title] = true
		})

		let query = '';
		for (let toner of tonersSet){
			query += `INSERT INTO toner_details_final (PrinterNumber, Matnr, Name, Capacity, Cost, imgURL, ProductURL, Rating) VALUES (${toner.printerNumber}, ${toner.matnr}, '${toner.title}', 0, ${toner.cost}, '','',${toner.rating});`;
		}

		try{
			let res = await Database.getInstance().promise().query(query)
			console.log(res)
		}catch(e){
			console.log(e)
		}


		await timer(5000);
	}
}

findToners();